<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ÁôæÊ•≠Êà∞ÂàÜÁµÑÊéíÁè≠Á≥ªÁµ± - Á∑äÊπäËá™ÂãïÂØ¨Â∫¶Áâà</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" async></script>
    <style>
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Heiti TC", sans-serif;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: max(15px, env(safe-area-inset-bottom));
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
        }

        .container {
            width: 100%;
            max-width: 1400px;
        }

        /* ÁÆ°ÁêÜÂÖ•Âè£ */
        .input-section {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .form-group {
            flex: 1;
            min-width: 150px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #444;
            font-size: 0.85em;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .checkbox-group label {
            font-weight: normal;
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .checkbox-group input {
            display: none;
        }

        /* :has() with JS fallback for older iOS */
        .checkbox-group label:has(input:checked),
        .checkbox-group label.checked {
            background: #e8f0fe;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        /* È†ÇÈÉ®ËßíËâ≤Â∫´ÔºöË™øÊï¥ÁÇ∫Êõ¥Á∑äÊπä */
        .repository-row {
            background: #d1d8e0;
            border: 2px dashed #888;
            border-radius: 12px;
            padding: 10px 15px;
            margin-bottom: 20px;
        }

        .repo-scroll-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 8px;
            min-height: 80px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        /* ËßíËâ≤Âç°ÁâáÂü∫Á§éÊ®£Âºè */
        .card {
            background: white;
            border-radius: 6px;
            padding: 6px 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: grab;
            position: relative;
            border-left: 4px solid #1a73e8;
            font-size: 0.8em;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
        }

        .card.dragging {
            opacity: 0.8;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            position: fixed;
            pointer-events: none;
        }

        /* ‚ú® ÈóúÈçµ‰øÆÊîπÔºöËßíËâ≤Â∫´Âç°ÁâáÂØ¨Â∫¶ÊîπÁÇ∫Ëá™Âãï */
        .repo-scroll-container .card {
            flex: 0 0 auto;
            min-width: 60px;
            /* ÊúÄÂ∞èÂØ¨Â∫¶Èò≤Ê≠¢Â§™Êì† */
            max-width: 200px;
            margin-bottom: 0;
            padding-right: 35px;
            /* ÁïôÁ©∫ÈñìÁµ¶Âè≥‰∏äËßíÊåâÈàï */
        }

        /* ‰∏ãÊñπÈöä‰ºçÊùøÂ°ä‰øùÊåÅÂõ∫ÂÆöÂØ¨Â∫¶‰ª•Á∂≠ÊåÅÊï¥ÈΩä */
        .board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            align-items: start;
        }

        .column {
            background: #e2e4e6;
            border-radius: 8px;
            min-height: 450px;
            padding: 10px;
            transition: 0.2s;
            position: relative;
        }

        .column.drop-hover {
            background: #c8e6c9;
            border: 2px dashed #4caf50;
        }

        .board .card {
            margin-bottom: 8px;
            width: auto;
        }

        /* Èöä‰ºçÊ®ôÈ°åÂçÄ */
        .column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            background: #5e6c84;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .column-title {
            border: none;
            background: transparent;
            color: white;
            font-weight: bold;
            font-size: 0.95em;
            width: 70%;
        }

        .column-title:focus {
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        /* ÊåâÈàïÊ®£Âºè */
        .card-btns {
            position: absolute;
            top: 4px;
            right: 4px;
            display: flex;
            gap: 2px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            color: #bbb;
            padding: 4px;
            min-width: 32px;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        @media (hover: hover) {
            .icon-btn:hover {
                color: #555;
            }
        }

        /* ËÅ∑Ê•≠ÈÖçËâ≤ */
        .job-tag {
            padding: 1px 4px;
            border-radius: 3px;
            margin-right: 2px;
            font-size: 0.7em;
            border: 1px solid;
            display: inline-block;
            margin-top: 2px;
            white-space: nowrap;
        }

        .job-red {
            background: #ffebee;
            color: #c62828;
            border-color: #ef9a9a;
        }

        .job-yellow {
            background: #fff9c4;
            color: #f57f17;
            border-color: #fff176;
        }

        .job-green {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #a5d6a7;
        }

        .job-blue {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #bbdefb;
        }

        .count-badge {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 10px;
            padding: 1px 5px;
            font-size: 0.75em;
        }

        button#addChar {
            padding: 0 15px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            height: 32px;
            font-size: 0.85em;
        }

        .save-hint {
            font-size: 0.7em;
            color: #4caf50;
            margin-left: 10px;
            display: none;
        }

        .action-btn {
            color: white;
            border: none;
            padding: 0 12px;
            border-radius: 6px;
            cursor: pointer;
            height: 36px;
            font-weight: bold;
            font-size: 0.85em;
            -webkit-tap-highlight-color: transparent;
            white-space: nowrap;
        }

        /* ===== RWD: ÊâãÊ©üÁâàÈù¢ ===== */
        @media (max-width: 768px) {
            body {
                padding: 8px;
                padding-top: max(8px, env(safe-area-inset-top));
                padding-bottom: max(8px, env(safe-area-inset-bottom));
            }

            .input-section {
                padding: 10px 12px;
            }

            .form-row {
                flex-direction: column;
                gap: 8px;
            }

            .form-group {
                min-width: 100% !important;
                flex: 1 1 100% !important;
            }

            .form-row button,
            .form-row .action-btn {
                width: 100%;
                height: 40px;
                margin-left: 0 !important;
            }

            .board {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }

            .column {
                min-height: 200px;
            }

            .repo-scroll-container {
                flex-wrap: wrap;
                min-height: 60px;
            }

            .repo-scroll-container .card {
                max-width: none;
            }

            .column-header {
                padding: 8px 10px;
            }

            .column-title {
                font-size: 1em;
            }

            h2 {
                font-size: 1em !important;
            }
        }

        /* Âπ≥Êùø‰ªãÈù¢ */
        @media (min-width: 769px) and (max-width: 1024px) {
            .board {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="input-section">
            <h2 style="margin:0 0 10px 0; font-size: 1.1em;">üõ†Ô∏è ËßíËâ≤ÁÆ°ÁêÜ <span id="saveStatus" class="save-hint">‚óè
                    Â∑≤Ëá™ÂãïÂÑ≤Â≠ò</span></h2>
            <div class="form-row">
                <input type="hidden" id="editingId" value="">
                <div class="form-group" style="flex: 1.5;">
                    <label>ËßíËâ≤ÂêçÁ®±</label>
                    <input type="text" id="charName" placeholder="Ëº∏ÂÖ•..."
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px;">
                </div>
                <div class="form-group" style="flex: 3;">
                    <label>ËÅ∑Ê•≠ (Èï∑Á¥Ö/ÈôåÈªÉ/Ë£úÁ∂†/‰ªñËóç)</label>
                    <div class="checkbox-group" id="jobGroup">
                        <label><input type="checkbox" value="ÈöäÈï∑"><span>‚≠êÈöäÈï∑</span></label>
                        <label><input type="checkbox" value="ÈôåÂàÄ"><span>ÈôåÂàÄ</span></label>
                        <label><input type="checkbox" value="Ë£ú"><span>Ë£ú</span></label>
                        <label><input type="checkbox" value="ÁéâÁéâ"><span>ÁéâÁéâ</span></label>
                        <label><input type="checkbox" value="ÁÑ°Âêç"><span>ÁÑ°Âêç</span></label>
                        <label><input type="checkbox" value="ÈÖíÈÖí"><span>ÈÖíÈÖí</span></label>
                        <label><input type="checkbox" value="ÈõôÂäç"><span>ÈõôÂäç</span></label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Â†¥Ê¨°</label>
                    <div class="checkbox-group" id="dayGroup">
                        <label><input type="checkbox" value="ÂÖ≠"><span>ÂÖ≠</span></label>
                        <label><input type="checkbox" value="Êó•"><span>Êó•</span></label>
                    </div>
                </div>
                <button id="addChar" onclick="handleNewOrUpdateCharacter()">ÂÑ≤Â≠ò</button>
                <button id="cancelEdit" onclick="resetForm()" style="display:none;">X</button>
                <button onclick="toggleImport()" class="action-btn" style="background: #34a853;">üì• ÂåØÂÖ•</button>
                <button onclick="downloadImage()" class="action-btn" style="background: #555;">üì∑ Â≠òÂúñ</button>
                <button onclick="toggleSettings()" class="action-btn" style="background: #607d8b;">‚öôÔ∏è Ë®≠ÂÆö</button>
            </div>

            <div id="importSection"
                style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <textarea id="csvInput" placeholder="Ë≤º‰∏ä CSV Ê†ºÂºè (username,message)..."
                    style="width: 100%; height: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 16px; box-sizing: border-box;"></textarea>
                <button onclick="processCSV()"
                    style="margin-top: 8px; background: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Á¢∫Ë™çÂåØÂÖ•</button>
            </div>

            <div id="settingsSection"
                style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <h4 style="margin-top: 0; margin-bottom: 10px;">È°ØÁ§∫Èöä‰ºç</h4>
                <div class="checkbox-group" id="teamVisibilityGroup"></div>
            </div>
        </div>

        <div class="repository-row">
            <h3 style="margin:0 0 5px 0; font-size:0.9em;">üìö ËßíËâ≤Â∫´ <span class="count-badge" id="count-repo"
                    style="background:#888">0</span></h3>
            <div id="repo" class="repo-scroll-container"></div>
        </div>

        <div class="board" id="mainBoard"></div>
    </div>

    <script>
        const storageKey = 'teamData_v2';
        let teamConfigs = [
            { id: 'team1', name: 'üö© Á¨¨‰∏ÄÈöä', visible: true },
            { id: 'team2', name: 'üö© Á¨¨‰∫åÈöä', visible: true },
            { id: 'team3', name: 'üö© Á¨¨‰∏âÈöä', visible: true },
            { id: 'teamMobile', name: '‚ö° Ê©üÂãïÈöä', visible: true }
        ];

        // ===== :has() CSS fallback for older iOS =====
        function updateCheckboxStyles() {
            document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(function (cb) {
                if (cb.checked) {
                    cb.parentElement.classList.add('checked');
                } else {
                    cb.parentElement.classList.remove('checked');
                }
            });
        }
        document.addEventListener('change', function (e) {
            if (e.target.matches('.checkbox-group input[type="checkbox"]')) {
                updateCheckboxStyles();
            }
        });

        // ===== localStorage with try/catch =====
        function safeGetStorage(key) {
            try {
                var data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.warn('localStorage read failed:', e);
                return null;
            }
        }

        function safeSetStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.warn('localStorage write failed:', e);
            }
        }

        // ===== Touch Drag and Drop System =====
        var touchDragState = null;
        var touchDragClone = null;
        var touchDragPlaceholder = null;

        function getDropTarget(x, y) {
            // Temporarily hide the clone so elementFromPoint can see through it
            if (touchDragClone) touchDragClone.style.display = 'none';
            var el = document.elementFromPoint(x, y);
            if (touchDragClone) touchDragClone.style.display = '';

            while (el && !(el.id === 'repo' || el.classList.contains('column'))) {
                el = el.parentElement;
            }
            return el;
        }

        function clearDropHighlights() {
            document.querySelectorAll('.drop-hover').forEach(function (el) {
                el.classList.remove('drop-hover');
            });
        }

        function onTouchStart(e) {
            var card = e.target.closest('.card');
            if (!card) return;
            // Don't interfere with button taps
            if (e.target.closest('.icon-btn')) return;

            var touch = e.touches[0];
            touchDragState = {
                card: card,
                startX: touch.clientX,
                startY: touch.clientY,
                isDragging: false,
                offsetX: 0,
                offsetY: 0
            };
        }

        function onTouchMove(e) {
            if (!touchDragState) return;
            var touch = e.touches[0];
            var dx = touch.clientX - touchDragState.startX;
            var dy = touch.clientY - touchDragState.startY;

            // Require minimum movement to start drag
            if (!touchDragState.isDragging) {
                if (Math.abs(dx) < 10 && Math.abs(dy) < 10) return;
                touchDragState.isDragging = true;

                // Create visual clone
                var rect = touchDragState.card.getBoundingClientRect();
                touchDragState.offsetX = touch.clientX - rect.left;
                touchDragState.offsetY = touch.clientY - rect.top;

                touchDragClone = touchDragState.card.cloneNode(true);
                touchDragClone.className = 'card dragging';
                touchDragClone.style.width = rect.width + 'px';
                touchDragClone.style.left = rect.left + 'px';
                touchDragClone.style.top = rect.top + 'px';
                document.body.appendChild(touchDragClone);

                // Dim original
                touchDragState.card.style.opacity = '0.3';
            }

            if (touchDragState.isDragging) {
                e.preventDefault();
                touchDragClone.style.left = (touch.clientX - touchDragState.offsetX) + 'px';
                touchDragClone.style.top = (touch.clientY - touchDragState.offsetY) + 'px';

                // Highlight drop target
                clearDropHighlights();
                var target = getDropTarget(touch.clientX, touch.clientY);
                if (target && target !== touchDragState.card.parentElement) {
                    target.classList.add('drop-hover');
                }
            }
        }

        function onTouchEnd(e) {
            if (!touchDragState) return;

            if (touchDragState.isDragging) {
                var touch = e.changedTouches[0];
                var target = getDropTarget(touch.clientX, touch.clientY);

                if (target) {
                    target.appendChild(touchDragState.card);
                    updateCounts();
                    saveState();
                }

                // Cleanup
                touchDragState.card.style.opacity = '';
                if (touchDragClone) {
                    touchDragClone.remove();
                    touchDragClone = null;
                }
                clearDropHighlights();
            }

            touchDragState = null;
        }

        document.addEventListener('touchstart', onTouchStart, { passive: true });
        document.addEventListener('touchmove', onTouchMove, { passive: false });
        document.addEventListener('touchend', onTouchEnd);

        // ===== Desktop Drag and Drop (kept for desktop browsers) =====
        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev) { ev.dataTransfer.setData("cardId", ev.target.id); }
        function drop(ev) {
            ev.preventDefault();
            var cardId = ev.dataTransfer.getData("cardId");
            if (cardId) {
                var target = ev.target;
                while (target && !(target.id === 'repo' || target.classList.contains('column'))) { target = target.parentElement; }
                if (target) {
                    target.appendChild(document.getElementById(cardId));
                    updateCounts();
                    saveState();
                }
            }
        }

        // ===== Init =====
        window.onload = function () {
            var savedData = safeGetStorage(storageKey);
            if (savedData && savedData.data) {
                if (savedData.configs) {
                    teamConfigs = savedData.configs.map(function (c) {
                        return Object.assign({}, c, { visible: c.visible !== false });
                    });
                }
                renderBoard();
                Object.keys(savedData.data).forEach(function (colId) {
                    var columnEl = document.getElementById(colId);
                    if (columnEl) {
                        savedData.data[colId].forEach(function (char) {
                            createCard(char.name, char.jobs, char.days, colId, char.id);
                        });
                    }
                });
            } else {
                renderBoard();
                createCard("Ëµ§Â±†", ["ÈôåÂàÄ"], [], 'repo');
                createCard("Ê¥õÁîØ", ["ÈöäÈï∑", "ÁéâÁéâ"], [], 'repo');
            }
            renderSettings();
            updateCheckboxStyles();
        };

        function renderBoard() {
            var board = document.getElementById('mainBoard');
            board.innerHTML = '';

            var visibleTeams = teamConfigs.filter(function (t) { return t.visible !== false; });
            // On mobile, CSS handles 1-column override; for desktop set dynamic columns
            board.style.gridTemplateColumns = 'repeat(' + visibleTeams.length + ', 1fr)';

            teamConfigs.forEach(function (config) {
                var col = document.createElement('div');
                col.className = 'column';
                col.id = config.id;
                col.ondrop = drop;
                col.ondragover = allowDrop;

                if (config.visible === false) {
                    col.style.display = 'none';
                }

                col.innerHTML =
                    '<div class="column-header" style="flex-wrap: wrap;">' +
                    '    <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">' +
                    '        <input class="column-title" value="' + config.name + '" onchange="saveState()">' +
                    '        <div class="header-actions">' +
                    '            <span class="count-badge" id="count-' + config.id + '">0</span>' +
                    '        </div>' +
                    '    </div>' +
                    '    <div id="stats-' + config.id + '" style="width:100%; font-size:0.75em; color:#ddd; margin-top:4px; display:flex; flex-wrap:wrap; gap:4px;"></div>' +
                    '</div>';
                board.appendChild(col);
            });
            updateCounts();
        }

        function saveState() {
            var data = {};
            var allCols = ['repo'].concat(teamConfigs.map(function (t) { return t.id; }));
            allCols.forEach(function (id) {
                var col = document.getElementById(id);
                if (col) {
                    data[id] = Array.from(col.querySelectorAll('.card')).map(function (c) {
                        return {
                            id: c.id,
                            name: c.dataset.name,
                            jobs: JSON.parse(c.dataset.jobs),
                            days: JSON.parse(c.dataset.days)
                        };
                    });
                }
            });
            var configs = teamConfigs.map(function (t) {
                var el = document.querySelector('#' + t.id + ' .column-title');
                return {
                    id: t.id,
                    name: el ? el.value : t.name,
                    visible: t.visible
                };
            });
            safeSetStorage(storageKey, { data: data, configs: configs });
            var hint = document.getElementById('saveStatus');
            hint.style.display = 'inline';
            setTimeout(function () { hint.style.display = 'none'; }, 1500);
        }

        function toggleSettings() {
            var div = document.getElementById('settingsSection');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        function renderSettings() {
            var container = document.getElementById('teamVisibilityGroup');
            container.innerHTML = '';
            teamConfigs.forEach(function (config) {
                var label = document.createElement('label');
                label.innerHTML = '<input type="checkbox" value="' + config.id + '" ' + (config.visible !== false ? 'checked' : '') + ' onchange="updateTeamVisibility(\'' + config.id + '\')"><span>' + config.name + '</span>';
                container.appendChild(label);
            });
            updateCheckboxStyles();
        }

        function updateTeamVisibility(id) {
            var config = teamConfigs.find(function (c) { return c.id === id; });
            if (config) {
                config.visible = !config.visible;
                var col = document.getElementById(id);
                if (col) col.style.display = config.visible ? 'block' : 'none';

                var visibleCount = teamConfigs.filter(function (t) { return t.visible !== false; }).length;
                document.getElementById('mainBoard').style.gridTemplateColumns = 'repeat(' + visibleCount + ', 1fr)';

                saveState();
                updateCheckboxStyles();
            }
        }

        function createCard(name, jobs, days, targetColId, existingId) {
            var cardId = existingId || "char-" + Date.now() + Math.random().toString(16).slice(2);
            var card = document.createElement('div');
            card.className = 'card';
            card.draggable = true;
            card.id = cardId;
            card.ondragstart = drag;
            card.dataset.name = name;
            card.dataset.jobs = JSON.stringify(jobs);
            card.dataset.days = JSON.stringify(days);

            var tags = jobs.map(function (j) {
                var cls = 'job-blue';
                if (j === 'ÈöäÈï∑') cls = 'job-red';
                else if (j === 'ÈôåÂàÄ') cls = 'job-yellow';
                else if (j === 'Ë£ú') cls = 'job-green';
                return '<span class="job-tag ' + cls + '">' + j + '</span>';
            }).join('');

            card.innerHTML =
                '<div class="card-btns">' +
                '    <button class="icon-btn" onclick="startEdit(\'' + cardId + '\')">‚úèÔ∏è</button>' +
                '    <button class="icon-btn" onclick="deleteCard(\'' + cardId + '\')">‚úï</button>' +
                '</div>' +
                '<strong>' + name + '</strong><br>' + tags;

            document.getElementById(targetColId).appendChild(card);
            updateCounts();
        }

        function handleNewOrUpdateCharacter() {
            var name = document.getElementById('charName').value.trim();
            var jobs = Array.from(document.querySelectorAll('#jobGroup input:checked')).map(function (cb) { return cb.value; });
            var days = Array.from(document.querySelectorAll('#dayGroup input:checked')).map(function (cb) { return cb.value; });
            var eid = document.getElementById('editingId').value;
            if (!name || jobs.length === 0) return;

            if (eid) {
                var old = document.getElementById(eid);
                var pid = old.parentElement.id;
                old.remove();
                createCard(name, jobs, days, pid, eid);
            } else {
                createCard(name, jobs, days, 'repo');
            }
            resetForm();
            saveState();
        }

        function startEdit(id) {
            var c = document.getElementById(id);
            document.getElementById('charName').value = c.dataset.name;
            document.getElementById('editingId').value = id;
            var jobs = JSON.parse(c.dataset.jobs);
            document.querySelectorAll('#jobGroup input').forEach(function (cb) {
                cb.checked = jobs.includes(cb.value);
            });
            document.getElementById('cancelEdit').style.display = 'inline';
            updateCheckboxStyles();
            document.getElementById('charName').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function resetForm() {
            document.getElementById('charName').value = '';
            document.getElementById('editingId').value = '';
            document.querySelectorAll('input:checked').forEach(function (cb) { cb.checked = false; });
            document.getElementById('cancelEdit').style.display = 'none';
            updateCheckboxStyles();
        }

        function deleteCard(id) {
            if (confirm("Á¢∫ÂÆöÂà™Èô§Ê≠§ËßíËâ≤Ôºü")) {
                document.getElementById(id).remove();
                updateCounts();
                saveState();
            }
        }

        function updateCounts() {
            var allIds = ['repo'].concat(teamConfigs.map(function (t) { return t.id; }));
            allIds.forEach(function (id) {
                var el = document.getElementById('count-' + id);
                var col = document.getElementById(id);
                if (el && col) {
                    var cards = col.querySelectorAll('.card');
                    el.innerText = cards.length;

                    // Update Job Stats
                    var statsEl = document.getElementById('stats-' + id);
                    if (statsEl) {
                        var jobCounts = {};
                        cards.forEach(function (c) {
                            var jobs = JSON.parse(c.dataset.jobs);
                            jobs.forEach(function (j) {
                                jobCounts[j] = (jobCounts[j] || 0) + 1;
                            });
                        });

                        var entries = Object.keys(jobCounts).map(function (job) {
                            return '<span style="background:rgba(255,255,255,0.2); padding:1px 4px; border-radius:3px; color: #555; border: 1px solid #ddd;">' + job + ':' + jobCounts[job] + '</span>';
                        });
                        statsEl.innerHTML = entries.length > 0 ? entries.join('') : '<span style="opacity:0.5; font-size: 0.9em;">-</span>';
                    }
                }
            });
        }

        // Column drag (desktop only) - removed on mobile, users reorder via settings
        var draggedColId = null;
        function dragColumn(ev) { draggedColId = ev.target.parentElement.id; }

        var mainBoard = document.getElementById('mainBoard');
        mainBoard.ondragover = function (e) { e.preventDefault(); };
        mainBoard.ondrop = function (e) {
            var targetCol = e.target.closest('.column');
            if (targetCol && draggedColId && targetCol.id !== draggedColId) {
                var fromIdx = teamConfigs.findIndex(function (t) { return t.id === draggedColId; });
                var toIdx = teamConfigs.findIndex(function (t) { return t.id === targetCol.id; });
                var movedItem = teamConfigs.splice(fromIdx, 1)[0];
                teamConfigs.splice(toIdx, 0, movedItem);
                saveState();
                // Re-render in place instead of location.reload()
                var savedData = safeGetStorage(storageKey);
                if (savedData && savedData.data) {
                    renderBoard();
                    Object.keys(savedData.data).forEach(function (colId) {
                        var columnEl = document.getElementById(colId);
                        if (columnEl) {
                            savedData.data[colId].forEach(function (char) {
                                createCard(char.name, char.jobs, char.days, colId, char.id);
                            });
                        }
                    });
                }
            }
        };

        function toggleImport() {
            var div = document.getElementById('importSection');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        function processCSV() {
            var text = document.getElementById('csvInput').value.trim();
            if (!text) return;
            var lines = text.split('\n');

            // Skip header if present
            var startIdx = lines[0].includes('username') ? 1 : 0;

            for (var i = startIdx; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;

                var parts = line.split(',');
                if (parts.length < 2) continue;

                var name = parts[0].trim();
                var rawMsg = parts.slice(1).join(',').trim();

                // Job Mapping
                var job = rawMsg;
                if (rawMsg === '99') job = 'ÈÖíÈÖí';
                else if (rawMsg === 'Â•∂') job = 'Ë£ú';
                else if (rawMsg === 'ÂäçÂäç') job = 'ÈõôÂäç';

                createCard(name, [job], [], 'repo');
            }

            document.getElementById('csvInput').value = '';
            toggleImport();
            saveState();
            alert('ÂåØÂÖ•ÂÆåÊàêÔºÅ');
        }

        function downloadImage() {
            if (typeof html2canvas === 'undefined') {
                alert('Êà™ÂúñÂäüËÉΩËºâÂÖ•‰∏≠ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
                return;
            }
            html2canvas(document.body, { scale: 1 }).then(function (canvas) {
                var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                if (isIOS && navigator.share) {
                    canvas.toBlob(function (blob) {
                        var file = new File([blob], 'team-distribution.png', { type: 'image/png' });
                        navigator.share({ files: [file] }).catch(function () {
                            // Fallback: open in new tab
                            window.open(canvas.toDataURL(), '_blank');
                        });
                    });
                } else if (isIOS) {
                    // iOS without Web Share API: open image in new tab for long-press save
                    window.open(canvas.toDataURL(), '_blank');
                } else {
                    var link = document.createElement('a');
                    link.download = 'team-distribution.png';
                    link.href = canvas.toDataURL();
                    link.click();
                }
            }).catch(function (err) {
                console.error('Screenshot failed:', err);
                alert('Êà™ÂúñÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
            });
        }
    </script>

</body>

</html>

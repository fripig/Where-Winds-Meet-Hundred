<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ÁôæÊ•≠Êà∞ÂàÜÁµÑÊéíÁè≠Á≥ªÁµ± - Á∑äÊπäËá™ÂãïÂØ¨Â∫¶Áâà</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icons/icon.svg">
    <script defer src="alpine.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" async></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body x-data="teamApp">

    <div class="container">
        <div class="input-section">
            <h2 style="margin:0 0 10px 0; font-size: 1.1em;">üõ†Ô∏è ËßíËâ≤ÁÆ°ÁêÜ <span x-show="saveStatus" x-transition class="save-hint">‚óè
                    Â∑≤Ëá™ÂãïÂÑ≤Â≠ò</span></h2>
            <div class="form-row">
                <div class="form-group" style="flex: 1.5;">
                    <label>ËßíËâ≤ÂêçÁ®±</label>
                    <input type="text" x-model="charName" placeholder="Ëº∏ÂÖ•..."
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px;">
                </div>
                <div class="form-group" style="flex: 3;">
                    <label>ËÅ∑Ê•≠ (Èï∑Á¥Ö/ÈôåÈªÉ/Ë£úÁ∂†/‰ªñËóç)</label>
                    <div class="checkbox-group">
                        <template x-for="(job, index) in availableJobs" :key="index">
                            <label :class="{ 'checked': selectedJobs.includes(job) }">
                                <input type="checkbox" :value="job" x-model="selectedJobs">
                                <span x-text="job === 'ÈöäÈï∑' ? '‚≠ê' + job : job"></span>
                            </label>
                        </template>
                    </div>
                </div>
                <div class="form-group">
                    <label>Â†¥Ê¨°</label>
                    <div class="checkbox-group">
                        <template x-for="day in ['ÂÖ≠', 'Êó•']" :key="day">
                            <label :class="{ 'checked': selectedDays.includes(day) }">
                                <input type="checkbox" :value="day" x-model="selectedDays">
                                <span x-text="day"></span>
                            </label>
                        </template>
                    </div>
                </div>
                <button id="addChar" @click="handleNewOrUpdateCharacter()">ÂÑ≤Â≠ò</button>
                <button x-show="editingId" @click="resetForm()">X</button>
                <button @click="showImport = !showImport" class="action-btn" style="background: #34a853;">üì• ÂåØÂÖ•CSV</button>
                <button @click="downloadImage()" class="action-btn" style="background: #555;">üì∑ Â≠òÂúñ</button>
                <button @click="exportTeamData()" class="action-btn" style="background: #1a73e8;">üíæ ÂåØÂá∫ÂàÜÈöä</button>
                <input type="file" accept=".json" @change="handleImportFile($event)" x-ref="importFile" style="display: none;">
                <button @click="$refs.importFile.click()" class="action-btn" style="background: #ea4335;">üìÇ ÂåØÂÖ•ÂàÜÈöä</button>
                <button @click="showSettings = !showSettings" class="action-btn" style="background: #607d8b;">‚öôÔ∏è Ë®≠ÂÆö</button>
            </div>

            <div x-show="showImport" x-transition
                style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <textarea x-model="csvInput" placeholder="Ë≤º‰∏ä CSV Ê†ºÂºè (username,message)..."
                    style="width: 100%; height: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 16px; box-sizing: border-box;"></textarea>
                <button @click="processCSV()"
                    style="margin-top: 8px; background: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Á¢∫Ë™çÂåØÂÖ•</button>
            </div>

            <div x-show="showSettings" x-transition
                style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <h4 style="margin-top: 0; margin-bottom: 10px;">È°ØÁ§∫Èöä‰ºç</h4>
                <div class="checkbox-group">
                    <template x-for="config in teamConfigs" :key="config.id">
                        <label :class="{ 'checked': config.visible }">
                            <input type="checkbox" :value="config.id" x-model="config.visible" @change="updateTeamVisibility()">
                            <span x-text="config.name"></span>
                        </label>
                    </template>
                </div>
            </div>
        </div>

        <div class="repository-row">
            <h3 style="margin:0 0 5px 0; font-size:0.9em;">üìö ËßíËâ≤Â∫´ <span class="count-badge"
                    style="background:#888" x-text="getColumnCount('repo')">0</span></h3>
            <div class="repo-scroll-container"
                 @drop="drop($event, 'repo')"
                 @dragover="dragOver($event)"
                 data-column="repo">
                <template x-for="card in getColumnCards('repo')" :key="card.id">
                    <div class="card"
                         draggable="true"
                         :data-card-id="card.id"
                         @dragstart="dragStart($event, card.id)"
                         @dragover.prevent
                         @touchstart="touchStart($event, card.id)"
                         @touchmove="touchMove($event)"
                         @touchend="touchEnd($event)">
                        <div class="card-btns">
                            <button class="icon-btn" @click="toggleMoveMenu(card.id)">‚§¥</button>
                            <button class="icon-btn" @click="startEdit(card.id)">‚úèÔ∏è</button>
                            <button class="icon-btn" @click="deleteCard(card.id)">‚úï</button>
                        </div>
                        <div class="move-menu" x-show="moveMenuCardId === card.id" @click.outside="moveMenuCardId = null">
                            <template x-for="col in getMoveTargets(card.id)" :key="col.id">
                                <button @click="moveCardTo(card.id, col.id)" x-text="col.name"></button>
                            </template>
                        </div>
                        <strong x-text="card.name"></strong><br>
                        <template x-for="job in card.jobs" :key="job">
                            <span class="job-tag" :class="getJobClass(job)" x-text="job"></span>
                        </template>
                    </div>
                </template>
            </div>
        </div>

        <div class="board" :style="'grid-template-columns: repeat(' + (visibleTeams.length + (jungleCards.length > 0 ? 1 : 0)) + ', 1fr)'">
            <template x-for="config in teamConfigs" :key="config.id">
                <div class="column"
                     x-show="config.visible"
                     @drop="drop($event, config.id)"
                     @dragover.prevent
                     :data-column="config.id">
                    <div class="column-header" style="flex-wrap: wrap;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <input class="column-title" x-model="config.name" @change="saveState()">
                            <div class="header-actions">
                                <span class="count-badge" x-text="getColumnCount(config.id)">0</span>
                            </div>
                        </div>
                        <div style="width:100%; font-size:0.75em; color:#ddd; margin-top:4px; display:flex; flex-wrap:wrap; gap:4px;">
                            <template x-for="(count, cat) in getCategoryStats(config.id)" :key="cat">
                                <span style="background:rgba(255,255,255,0.25); padding:1px 4px; border-radius:3px; color: #fff; border: 1px solid rgba(255,255,255,0.4);">
                                    <span x-text="cat + ':' + count"></span>
                                </span>
                            </template>
                            <span x-show="Object.keys(getCategoryStats(config.id)).length === 0" style="opacity:0.5; font-size: 0.9em;">-</span>
                        </div>
                    </div>
                    <template x-for="cat in getCategoryCards(config.id)" :key="cat.id">
                        <div class="category-section"
                             :data-category="cat.id"
                             @drop.stop="dropToCategory($event, config.id, cat.id)"
                             @dragover.prevent.stop="dragOverCategory($event)">
                            <div class="category-header" @click="toggleCategory(config.id, cat.id)">
                                <span>
                                    <span class="cat-toggle" :class="{ 'collapsed': isCategoryCollapsed(config.id, cat.id) }">‚ñº</span>
                                    <span x-text="cat.name"></span>
                                </span>
                                <span class="cat-count" x-text="cat.cards.length"></span>
                            </div>
                            <div class="category-cards"
                                 x-show="!isCategoryCollapsed(config.id, cat.id)"
                                 :data-column="config.id"
                                 :data-category-drop="cat.id">
                                <template x-for="card in cat.cards" :key="card.id">
                                    <div class="card"
                                         draggable="true"
                                         :data-card-id="card.id"
                                         @dragstart="dragStart($event, card.id)"
                                         @dragover.prevent.stop
                                         @touchstart="touchStart($event, card.id)"
                                         @touchmove="touchMove($event)"
                                         @touchend="touchEnd($event)">
                                        <div class="card-btns">
                                            <button class="icon-btn" @click="toggleMoveMenu(card.id)">‚§¥</button>
                                            <button class="icon-btn" @click="startEdit(card.id)">‚úèÔ∏è</button>
                                            <button class="icon-btn" @click="moveCardTo(card.id, 'repo')" title="ÁßªÂá∫Èöä‰ºç">‚Ü©</button>
                                        </div>
                                        <div class="move-menu" x-show="moveMenuCardId === card.id" @click.outside="moveMenuCardId = null">
                                            <template x-for="col in getMoveTargets(card.id)" :key="col.id">
                                                <button @click="moveCardTo(card.id, col.id)" x-text="col.name"></button>
                                            </template>
                                        </div>
                                        <strong x-text="card.name"></strong><br>
                                        <template x-for="job in card.jobs" :key="job">
                                            <span class="job-tag" :class="getJobClass(job)" x-text="job"></span>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
            <!-- ÊâìÈáéÈöä (virtual read-only column) -->
            <div class="column" x-show="jungleCards.length > 0">
                <div class="column-header">
                    <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                        <span class="column-title" style="font-weight:bold; font-size:0.95em;">üåø ÊâìÈáéÈöä</span>
                        <div class="header-actions">
                            <span class="count-badge" x-text="jungleCards.length">0</span>
                        </div>
                    </div>
                </div>
                <template x-for="card in jungleCards" :key="'jungle-' + card.id">
                    <div class="card" style="cursor: default;">
                        <strong x-text="card.name"></strong><br>
                        <template x-for="job in card.jobs" :key="job">
                            <span class="job-tag" :class="getJobClass(job)" x-text="job"></span>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script src="src/alpine-app.js"></script>
    <script>if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');</script>

</body>

</html>
